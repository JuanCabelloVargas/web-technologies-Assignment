<div class="container mt-3">
  <div class="d-flex justify-content-between flex-wrap gap-2 mb-3">
    <h1 class="text-primary mb-0"><%= @challenge.name %></h1>
    <div class="d-flex gap-2">
      <% if current_user && @challenge.creator_id == current_user.id %>
        <%= link_to "Edit", edit_challenge_path(@challenge), class: "btn btn-outline-primary" %>
        <%= button_to "Delete", challenge_path(@challenge),
                      method: :delete,
                      data: { confirm: "Are you sure you want to delete this challenge?" },
                      class: "btn btn-outline-danger" %>
      <% end %>
    </div>
  </div>

  <div class="card mb-4">
    <div class="card-body">
      <p><strong>Description:</strong> <%= simple_format(@challenge.description) %></p>
      <p class="mb-1">
        <strong>Dates:</strong>
        <%= l(@challenge.start_date, format: :long) %> — <%= l(@challenge.end_date, format: :long) %>
      </p>
      <p class="mb-1"><strong>Category:</strong> <%= @challenge.category.name %></p>
      <p class="mb-1"><strong>Visibility:</strong> <%= @challenge.visibility.titleize %></p>
      <p class="mb-0"><strong>Status:</strong> <%= @challenge.status.titleize %></p>
    </div>
  </div>

  <div class="card mb-4">
    <div class="card-body">
      <h5 class="card-title">Access requests</h5>
      <% if current_user.nil? %>
        <p class="mb-0 text-muted">Sign in to request access.</p>
      <% elsif @challenge.creator_id == current_user.id %>
        <p class="mb-0 text-muted">You are the creator of this challenge.</p>
      <% elsif @challenge_request.present? %>
        <div class="alert alert-info mb-3">
          <strong>Request sent:</strong> Status <%= @challenge_request.status.capitalize %>
          <% if @challenge_request.decided_by.present? %>
            · Decided by <%= @challenge_request.decided_by.username %>
          <% end %>
        </div>
      <% else %>
        <%= form_with url: challenge_challenge_requests_path(@challenge), method: :post, local: true do |f| %>
          <div class="mb-3">
            <%= f.label :message, "Message for the creator", class: "form-label" %>
            <%= f.text_area :message, rows: 3, class: "form-control", name: "challenge_request[message]" %>
          </div>
          <%= f.submit "Request access", class: "btn btn-outline-primary" %>
        <% end %>
      <% end %>

      <% if @user_requests.any? %>
        <hr>
        <h6>Your requests</h6>
        <ul class="list-group">
          <% @user_requests.each do |request| %>
            <li class="list-group-item d-flex justify-content-between flex-wrap gap-2">
              <span>
                <strong><%= request.status.capitalize %></strong>
                · <%= l(request.created_at, format: :short) %>
              </span>
              <% if request.decided_by %>
                <span class="text-muted small">Decided by <%= request.decided_by.username %></span>
              <% end %>
            </li>
          <% end %>
        </ul>
      <% end %>
    </div>
  </div>

  <div class="mb-4">
    <% if current_user %>
      <% if @participation %>
        <%= button_to "Leave challenge",
                      challenge_challenge_participation_path(@challenge, @participation),
                      method: :delete,
                      class: "btn btn-outline-secondary" %>
      <% else %>
        <%= button_to "Join challenge",
                      challenge_challenge_participations_path(@challenge),
                      method: :post,
                      class: "btn btn-primary" %>
      <% end %>
    <% else %>
      <div class="alert alert-info mb-0">Sign in to join this challenge.</div>
    <% end %>
  </div>

  <ul class="nav nav-tabs" role="tablist">
    <li class="nav-item" role="presentation">
      <a class="nav-link active" href="#participantes" data-bs-toggle="tab">Participants</a>
    </li>
    <li class="nav-item" role="presentation">
      <a class="nav-link" href="#progreso" data-bs-toggle="tab">Progress</a>
    </li>
    <li class="nav-item" role="presentation">
      <a class="nav-link" href="#comentarios" data-bs-toggle="tab">Comments</a>
    </li>
  </ul>

  <div class="tab-content pt-3">
    <div class="tab-pane fade show active" id="participantes" role="tabpanel">
      <%= render partial: "challenge_participations/list", locals: { participations: @participations, challenge: @challenge } %>
    </div>
    <div class="tab-pane fade" id="progreso" role="tabpanel">
      <%= render partial: "progress_logs/section", locals: { challenge: @challenge, progress_logs: @progress_logs, progress_log: @progress_log, can_log_progress: @can_log_progress } %>
    </div>
    <div class="tab-pane fade" id="comentarios" role="tabpanel">
      <%= render partial: "challenge_comments/section", locals: { challenge: @challenge, comments: @comments, comment: @comment } %>
    </div>
  </div>
</div>
